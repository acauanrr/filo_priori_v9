%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#667eea',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#5a67d8',
    'lineColor': '#718096',
    'secondaryColor': '#48bb78',
    'tertiaryColor': '#ed8936',
    'background': '#f7fafc',
    'mainBkg': '#edf2f7',
    'nodeBorder': '#4a5568',
    'clusterBkg': '#ffffff',
    'clusterBorder': '#e2e8f0',
    'titleColor': '#2d3748',
    'edgeLabelBackground': '#ffffff',
    'fontFamily': 'Inter, system-ui, sans-serif'
  }
}}%%

flowchart TB
    %% ==================== STYLING ====================
    classDef data fill:#c6f6d5,stroke:#276749,stroke-width:2px,color:#22543d,font-weight:bold
    classDef semantic fill:#bee3f8,stroke:#2b6cb0,stroke-width:2px,color:#2c5282,font-weight:bold
    classDef structural fill:#feebc8,stroke:#c05621,stroke-width:2px,color:#744210,font-weight:bold
    classDef fusion fill:#fed7e2,stroke:#b83280,stroke-width:2px,color:#702459,font-weight:bold
    classDef training fill:#e9d8fd,stroke:#6b46c1,stroke-width:2px,color:#44337a,font-weight:bold
    classDef eval fill:#fefcbf,stroke:#b7791f,stroke-width:2px,color:#744210,font-weight:bold
    classDef output fill:#b2f5ea,stroke:#285e61,stroke-width:2px,color:#234e52,font-weight:bold

    %% ==================== MAIN FLOW ====================

    subgraph DATA["ğŸ“ DATA LAYER"]
        direction LR
        D1[("ğŸ—‚ï¸ train.csv")]
        D2[("ğŸ—‚ï¸ test.csv")]
        D3["ğŸ”€ DataLoader<br/><i>Build-level splits</i>"]
    end

    subgraph STREAMS["ğŸ”„ DUAL-STREAM PROCESSING"]
        direction TB

        subgraph SEM["ğŸ”¤ SEMANTIC STREAM"]
            direction TB
            S1["ğŸ“ Text Input<br/><i>TC_Summary + Steps + Commits</i>"]
            S2["ğŸ¤– SBERT Encoder<br/><i>all-mpnet-base-v2</i>"]
            S3["ğŸ“Š 1536-dim Embedding"]
            S4["ğŸ§  FFN Layers<br/><i>1536 â†’ 256</i>"]
            S5(["Semantic<br/>Features<br/><b>256-dim</b>"])
        end

        subgraph STRUCT["ğŸ“Š STRUCTURAL STREAM"]
            direction TB
            T1["ğŸ“ˆ Feature Extraction<br/><i>19 features (10 base + 9 DeepOrder)</i>"]
            T2["ğŸ•¸ï¸ Multi-Edge Graph<br/><i>co-fail, co-pass, semantic,<br/>temporal, component</i>"]
            T3["âš¡ GAT Network<br/><i>2 heads, 1 layer</i>"]
            T4(["Structural<br/>Features<br/><b>256-dim</b>"])
        end
    end

    subgraph FUSION_BLOCK["ğŸ”— FUSION & CLASSIFICATION"]
        direction TB
        F1["âœ¨ Cross-Attention<br/><i>Bidirectional, 4 heads</i>"]
        F2["ğŸ“¦ Concatenation<br/><i>512-dim</i>"]
        F3["ğŸ¯ MLP Classifier<br/><i>512 â†’ 128 â†’ 64 â†’ 2</i>"]
        F4(["P(Fail)<br/>per test"])
    end

    subgraph TRAIN_BLOCK["âš¡ TRAINING"]
        direction LR
        TR1["âš–ï¸ Balanced<br/>Sampling<br/><i>10:1 ratio</i>"]
        TR2["ğŸ¯ Focal Loss<br/><i>Î±=0.5, Î³=2.0</i>"]
        TR3["ğŸ“‰ AdamW<br/><i>lr=3e-5</i>"]
        TR4["ğŸ›‘ Early Stop<br/><i>patience=15</i>"]
    end

    subgraph POST["ğŸ”§ POST-PROCESSING"]
        direction TB
        P1["ğŸšï¸ Threshold<br/>Optimization<br/><i>Two-phase search</i>"]
        P2["ğŸ” Orphan<br/>Handling<br/><i>KNN + structural blend</i>"]
        P3["ğŸ“‹ Hybrid<br/>Ranking"]
    end

    subgraph EVAL_BLOCK["ğŸ“ˆ EVALUATION"]
        direction LR
        E1["ğŸ“Š APFD<br/>per build"]
        E2["ğŸ† Final Metrics<br/><b>Mean: 0.7595</b><br/><b>Median: 0.7944</b>"]
    end

    subgraph OUT["ğŸ’¾ OUTPUT"]
        direction LR
        O1[("ğŸ“„ prioritized_<br/>test_cases.csv")]
        O2[("ğŸ“„ apfd_per_<br/>build.csv")]
        O3[("ğŸ’¿ best_<br/>model.pt")]
    end

    %% ==================== CONNECTIONS ====================

    %% Data flow
    D1 --> D3
    D2 --> D3
    D3 --> S1
    D3 --> T1

    %% Semantic stream
    S1 --> S2
    S2 --> S3
    S3 --> S4
    S4 --> S5

    %% Structural stream
    T1 --> T2
    T2 --> T3
    T3 --> T4

    %% Graph uses embeddings
    S3 -.->|semantic edges| T2

    %% Fusion
    S5 --> F1
    T4 --> F1
    F1 --> F2
    F2 --> F3
    F3 --> F4

    %% Training
    F4 --> TR1
    TR1 --> TR2
    TR2 --> TR3
    TR3 --> TR4

    %% Post-processing
    F4 --> P1
    F4 --> P2
    S3 -.->|KNN similarity| P2
    P1 --> P3
    P2 --> P3

    %% Evaluation
    P3 --> E1
    E1 --> E2

    %% Output
    P3 --> O1
    E1 --> O2
    TR4 --> O3

    %% Apply styles
    class D1,D2,D3 data
    class S1,S2,S3,S4,S5 semantic
    class T1,T2,T3,T4 structural
    class F1,F2,F3,F4 fusion
    class TR1,TR2,TR3,TR4 training
    class P1,P2,P3,E1,E2 eval
    class O1,O2,O3 output
