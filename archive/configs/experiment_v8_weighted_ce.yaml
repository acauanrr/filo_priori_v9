# Filo-Priori V8 - Weighted Cross-Entropy Configuration
# Solução para o colapso de predição causado por Focal Loss extremo
#
# PROBLEMA ANTERIOR:
# - Focal Loss alpha=[0.995, 0.005] criava ratio 199:1
# - Ratio 5.4x mais agressivo que imbalance natural (37:1)
# - Modelo colapsava: prevê TUDO como classe 0 (Fail)
# - Resultado: Accuracy 3%, Recall Pass 0%, Recall Fail 100%
#
# SOLUÇÃO:
# - Usar Weighted Cross-Entropy com class weights naturais
# - Class weights calculados automaticamente: [19.0, 0.51] → ratio 37:1
# - Mais intuitivo, menos propenso a colapso
# - Amplamente testado e validado
#
# REFERÊNCIA: ANALISE_FOCAL_LOSS_PROBLEMA.md

experiment:
  name: "v8_weighted_ce"
  version: "8.0.2"
  description: "V8 with Weighted Cross-Entropy instead of problematic Focal Loss"
  seed: 42

# Data Configuration
data:
  train_path: "datasets/train.csv"
  test_path: "datasets/test.csv"

  train_split: 0.8
  val_split: 0.1
  test_split: 0.1
  random_seed: 42

  binary_classification: true
  binary_strategy: "pass_vs_fail"  # Only Pass vs Fail (excludes Delete/Blocked/etc.)
  binary_positive_class: "Pass"    # Class 1
  binary_negative_class: "Fail"    # Class 0

  smote:
    enabled: false
    k_neighbors: 5
    sampling_strategy: "auto"

# Text Processing Configuration
text:
  num_commits_to_keep: 3
  max_commit_length: 512
  max_summary_length: 256
  max_steps_length: 512

# Semantic Embeddings
semantic:
  model_name: "models/finetuned_bge_v1"
  embedding_dim: 1024
  max_length: 512
  batch_size: 32
  pooling_strategy: "mean"
  normalize_embeddings: true
  cache_path: "cache/embeddings"

  fields:
    - "TE_Summary"
    - "TC_Steps"
    - "commit"

# Structural Features
structural:
  extractor:
    recent_window: 5
    min_history: 2
    cache_path: "cache/structural_features.pkl"

  input_dim: 6

# Phylogenetic Graph
graph:
  type: "co_failure"
  min_co_occurrences: 2
  weight_threshold: 0.1
  cache_path: "cache/phylogenetic_graph.pkl"
  build_graph: true

# Model Architecture
model:
  type: "dual_stream_v8"

  # Semantic Stream
  semantic:
    input_dim: 1024
    hidden_dim: 256
    num_layers: 2
    dropout: 0.2
    activation: "gelu"

  # Structural Stream
  structural:
    input_dim: 6
    hidden_dim: 256
    num_heads: 4
    dropout: 0.2
    activation: "elu"
    use_edge_weights: true

  # Fusion Layer
  fusion:
    type: "cross_attention"
    num_heads: 4
    dropout: 0.1

  # Classifier
  classifier:
    hidden_dims: [128, 64]
    dropout: 0.3

  num_classes: 2

# Training Configuration
training:
  num_epochs: 50
  batch_size: 32
  learning_rate: 1e-4
  weight_decay: 5e-5

  optimizer:
    type: "AdamW"
    betas: [0.9, 0.999]
    eps: 1e-8

  scheduler:
    type: "cosine"
    T_max: 50
    eta_min: 1e-6

  grad_clip_norm: 1.0

  # Early stopping
  early_stopping:
    enabled: true
    patience: 20
    monitor: "val_f1_macro"
    mode: "max"
    min_delta: 0.001

  use_amp: false

# Loss Function - WEIGHTED CROSS-ENTROPY (SOLUTION!)
loss:
  type: "weighted_ce"

  # Weighted CE parameters - RECOMMENDED SOLUTION
  weighted_ce:
    use_class_weights: true  # Uses class_weights from DataLoader
    label_smoothing: 0.0     # No label smoothing for binary classification
    #
    # Class weights will be computed automatically from data:
    # - Pass: 61,224 samples → weight ≈ 0.51
    # - Fail: 1,654 samples → weight ≈ 19.0
    # - Ratio: 19.0 / 0.51 ≈ 37:1 (matches natural imbalance)
    #
    # This creates a REASONABLE penalty for misclassifying Fail,
    # without the extreme 199:1 ratio that caused collapse.

  # For reference, these were the problematic focal loss values:
  # focal:
  #   alpha: [0.995, 0.005]  # ❌ TOO EXTREME - ratio 199:1
  #   gamma: 3.5             # ❌ Caused total prediction collapse

# Evaluation Configuration
evaluation:
  metrics:
    - "accuracy"
    - "f1_macro"
    - "f1_weighted"
    - "precision"
    - "recall"
    - "auprc"
    - "confusion_matrix"
    - "prediction_diversity"  # Monitor collapse

  temperature_scaling:
    enabled: true
    initial_T: 1.0

  # Threshold search
  threshold_search:
    enabled: true
    search_range: [0.1, 0.9]
    search_step: 0.05
    metric: "f1_macro"

# APFD Configuration
apfd:
  expected_builds: 277
  count_tc_1_rule: true
  only_fail_results: true
  save_prioritized_tests: true
  save_apfd_per_build: true

# Logging Configuration
logging:
  level: "INFO"
  log_to_file: true
  log_file: "logs/experiment_v8_weighted_ce.log"
  log_to_tensorboard: true
  tensorboard_dir: "runs/experiment_v8_weighted_ce"

  checkpoint:
    save_best: true
    save_last: true
    save_every_n_epochs: 10

# Output Configuration
output:
  results_dir: "results/experiment_v8_weighted_ce"
  save_predictions: true
  save_features: true
  save_confusion_matrix: true
  save_pr_curves: true

# Hardware Configuration
hardware:
  device: "cuda"
  num_workers: 4
  pin_memory: true

# ============================================================================
# EXPECTED RESULTS (Weighted CE):
# ============================================================================
# DATASET:
# - Training samples: ~62,878 (61,224 Pass + 1,654 Fail)
# - Class ratio: 97.4% Pass / 2.6% Fail (37:1)
#
# EXPECTED METRICS:
# 1. Recall Fail: 0% → ≥40% (detect at least 40% of failures)
# 2. Recall Pass: 100% (collapsed) → ≥95% (maintain high Pass detection)
# 3. Prediction Diversity: 0.0 → ≥0.30 (both classes predicted)
# 4. F1 Macro: 0.03 → ≥0.65 (balanced performance)
# 5. Accuracy: 3% → ≥95% (high overall with 97% Pass baseline)
# 6. Precision Fail: undefined → ≥35% (avoid too many false alarms)
#
# SUCCESS CRITERIA (GO):
# - Prediction Diversity ≥ 0.30 (both classes being predicted)
# - Recall Fail ≥ 0.40 (detecting at least 40% of Fail cases)
# - Recall Pass ≥ 0.95 (maintaining high Pass detection)
# - Precision Fail ≥ 0.30 (acceptable false alarm rate)
# - F1 Macro ≥ 0.60 (balanced performance)
# - Test Accuracy ≥ 0.95 (high overall performance)
#
# NO-GO CRITERIA (FAILURE):
# - Prediction Diversity < 0.20 (still collapsing)
# - Recall Fail < 0.30 (not detecting enough failures)
# - F1 Macro < 0.50 (no significant improvement)
# - Model still predicting >95% as single class
#
# VALIDATION COMMANDS:
# python main_v8.py --config configs/experiment_v8_weighted_ce.yaml --device cuda
#
# CHECK RESULTS:
# - results/experiment_v8_weighted_ce/confusion_matrix.png (visual check)
# - results/experiment_v8_weighted_ce/apfd_per_build_FULL_testcsv.csv (277 builds)
# - grep "Final Test" results/experiment_v8_weighted_ce/tmux-buffer.txt
# ============================================================================
