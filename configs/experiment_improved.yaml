# Filo-Priori - Improved Configuration
# WITH CRITICAL FIXES FOR CLASS COLLAPSE
#
# Key Improvements:
# 1. WeightedFocalLoss (class weights + focal modulation + alpha)
# 2. Balanced Sampling (oversample minority class 20:1)
# 3. Multi-Edge Graph (co-failure + co-success + semantic)
# 4. Threshold Optimization (not fixed at 0.5)
#
# Expected Impact:
# - Fix class collapse (Precision/Recall Not-Pass: 0.00 → 0.50+)
# - Increase graph density (0.02% → 0.5-1.0%)
# - Better minority class detection

experiment:
  name: "filo_priori_improved"
  version: "2.0.0"
  description: "Improved pipeline with fixes for class collapse and sparse graph"
  seed: 42

# Data Configuration
data:
  train_path: "datasets/01_industry/train.csv"
  test_path: "datasets/01_industry/test.csv"

  train_split: 0.8
  val_split: 0.1
  test_split: 0.1
  random_seed: 42

  binary_classification: true
  binary_strategy: "pass_vs_fail"
  binary_positive_class: "Pass"
  binary_negative_class: "Fail"

  smote:
    enabled: false

# Text Processing
text:
  num_commits_to_keep: 5
  max_commit_length: 2000
  max_summary_length: 500
  max_steps_length: 1000

# Commit Extraction
commit:
  max_commits_per_tc: 10
  include_commit_metadata: true

# Semantic Embeddings with SBERT
embedding:
  model_name: "sentence-transformers/all-mpnet-base-v2"
  embedding_dim: 768
  combined_embedding_dim: 1536  # TC (768) + Commit (768)

  max_length: 384
  batch_size: 128
  normalize_embeddings: true
  device: "cuda"

  use_cache: true
  cache_dir: "cache"

# Alias for backward compatibility
semantic:
  model_name: "sentence-transformers/all-mpnet-base-v2"
  embedding_dim: 768
  combined_embedding_dim: 1536
  max_length: 384
  batch_size: 128

# Structural Features
structural:
  extractor:
    recent_window: 5
    min_history: 2
    cache_path: "cache/structural_features.pkl"
  input_dim: 6

# Phylogenetic Graph - IMPROVED WITH MULTI-EDGE
graph:
  build_graph: true

  # NEW: Multi-edge mode
  use_multi_edge: true

  # Edge types to include
  edge_types:
    - co_failure    # Tests that fail together
    - co_success    # Tests that pass together (negative correlation)
    - semantic      # Top-k similar tests from embeddings

  # Edge type weights (for weighted combination)
  edge_weights:
    co_failure: 1.0   # Strongest signal
    co_success: 0.5   # Complementary info
    semantic: 0.3     # Additional connectivity

  # Reduced thresholds for denser graph
  min_co_occurrences: 1    # Was 2 (more permissive)
  weight_threshold: 0.05   # Was 0.1 (more permissive)

  # Semantic edge parameters
  semantic_top_k: 10           # Connect each node to top-10 similar
  semantic_threshold: 0.7      # Min cosine similarity

  # Cache
  cache_path: "cache/multi_edge_graph.pkl"

  # Legacy (ignored when use_multi_edge=true)
  type: "co_failure"

# Model Architecture
model:
  type: "dual_stream"
  num_classes: 2

  semantic:
    input_dim: 1536
    hidden_dim: 256
    num_layers: 2
    dropout: 0.15
    activation: "gelu"

  structural:
    input_dim: 6
    hidden_dim: 64
    num_layers: 2
    dropout: 0.15
    activation: "gelu"

  gnn:
    type: "GAT"
    hidden_dim: 128
    num_layers: 2
    num_heads: 4
    dropout: 0.2
    activation: "elu"

  fusion:
    input_dim: 384
    hidden_dim: 256
    num_layers: 2
    dropout: 0.2
    activation: "gelu"

  classifier:
    input_dim: 256
    hidden_dim: 128
    num_classes: 2
    dropout: 0.3

# Training Configuration - WITH BALANCED SAMPLING
training:
  num_epochs: 50
  epochs: 50
  batch_size: 32
  learning_rate: 0.00005  # 5e-5
  weight_decay: 0.0001    # 1e-4

  optimizer: "adamw"
  scheduler:
    type: "cosine"
    eta_min: 0.000001
  warmup_epochs: 5

  gradient_clip: 1.0
  accumulation_steps: 1

  early_stopping:
    patience: 12
    min_delta: 0.001
    monitor: "val_f1_macro"
    mode: "max"

  # NEW: Balanced Sampling
  sampling:
    use_balanced_sampling: true
    minority_weight: 1.0    # Weight for minority class (Fail)
    majority_weight: 0.05   # Weight for majority class (Pass)
                            # Ratio: 20:1 oversampling of minority

  # NEW: Loss Configuration - WeightedFocalLoss
  loss:
    type: "weighted_focal"  # STRONGEST loss for extreme imbalance

    # Focal Loss parameters
    focal_alpha: 0.75      # Higher = more weight to minority (was 0.25)
    focal_gamma: 3.0       # Higher = more focus on hard examples (was 2.0)

    # Label smoothing (optional)
    label_smoothing: 0.0   # Can add 0.05-0.1 for regularization

    # Note: Class weights are computed automatically from training data
    # Expected: [~19.13, ~0.51] for 37:1 imbalance

# Legacy loss config (for backward compatibility)
loss:
  type: "weighted_focal"
  focal_alpha: 0.75
  focal_gamma: 3.0
  label_smoothing: 0.0

# Evaluation - WITH THRESHOLD OPTIMIZATION
evaluation:
  metrics:
    - "accuracy"
    - "precision"
    - "recall"
    - "f1_macro"
    - "f1_weighted"
    - "auprc_macro"
    - "auroc"

  # Threshold optimization (not fixed at 0.5)
  threshold_search:
    enabled: true
    range: [0.01, 0.99]    # Wider range (was [0.2, 0.8])
    step: 0.01             # Finer granularity (was 0.05)
    optimize_for: "f1_macro"

# Ranking Configuration
ranking:
  method: "probability"
  reverse: true

  apfd_calculation:
    enabled: true
    fault_column: "verdict"
    fault_value: "Fail"

# System Configuration
system:
  device: "cuda"
  num_workers: 4
  pin_memory: true
  use_amp: false

  deterministic: true
  benchmark: false

# Alias for validator
hardware:
  device: "cuda"
  num_workers: 4

# Logging and Checkpointing
logging:
  level: "INFO"
  log_dir: "logs"
  tensorboard: false

checkpoint:
  save_best: true
  save_last: true
  monitor: "val_f1_macro"
  mode: "max"

output:
  results_dir: "results/experiment_improved"
  save_predictions: true
  save_rankings: true
  save_apfd: true
  save_plots: true
