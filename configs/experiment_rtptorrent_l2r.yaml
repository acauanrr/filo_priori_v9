# =============================================================================
# RTPTorrent Learning-to-Rank Experiment Configuration
# =============================================================================
# This configuration is optimized for the RTPTorrent dataset which has:
# - Very sparse failures (0.20% failure rate)
# - Limited semantic information (only class names)
# - Strong structural/historical signals
# - 7 baseline strategies for comparison
# =============================================================================

experiment:
  name: "rtptorrent_learning_to_rank"
  description: "Learning-to-Rank TCP on RTPTorrent benchmark"
  version: "1.0.0"
  mode: "ranking"  # ranking mode instead of classification

# =============================================================================
# DATASET CONFIGURATION
# =============================================================================
dataset:
  name: "rtptorrent"
  base_path: "datasets/02_rtptorrent"
  processed_path: "datasets/02_rtptorrent/processed_ranking"
  raw_path: "datasets/02_rtptorrent/raw/MSR2"

  # Projects to use (from preset: small, medium, large, or custom list)
  projects:
    preset: "all"  # all = all 20 projects
    # custom: ["square@okhttp", "jOOQ@jOOQ"]

  # Data loading
  train_file: "train.csv"
  test_file: "test.csv"

  # Columns mapping
  columns:
    build_id: "Build_ID"
    test_key: "TC_Key"
    test_name: "testName"
    semantic_text: "semantic_text"
    relevance: "is_failure"  # Binary: 1 for failure, 0 for pass
    # Historical features
    historical_features:
      - "total_executions"
      - "total_failures"
      - "failure_rate"
      - "recent_failures"
      - "recent_executions"
      - "avg_duration"
      - "last_failure_recency"
      - "is_new_test"
      - "duration"

# =============================================================================
# MODEL CONFIGURATION
# =============================================================================
model:
  type: "ranking_model"

  # Feature dimensions
  semantic_dim: 768  # SBERT embedding dimension
  structural_dim: 9  # Number of historical features

  # Architecture
  semantic_stream:
    hidden_dim: 128
    num_layers: 2
    dropout: 0.3
    activation: "relu"

  structural_stream:
    hidden_dim: 64
    num_layers: 2
    dropout: 0.2
    activation: "relu"
    # Structural features are more important for RTPTorrent
    weight: 2.0  # Give more weight to structural stream

  fusion:
    type: "concatenate"  # concatenate, attention, or gate
    hidden_dim: 128
    dropout: 0.3

  # Output: single score for ranking
  output:
    type: "score"  # score (regression) instead of classification
    hidden_dim: 64

# =============================================================================
# TRAINING CONFIGURATION
# =============================================================================
training:
  # Learning-to-Rank loss
  ranking_loss:
    type: "listnet"  # listnet, listmle, lambdarank, approx_ndcg, mse
    temperature: 1.0
    # For lambdarank:
    # sigma: 1.0
    # k: 20  # NDCG@k

  # Optimizer
  optimizer:
    type: "adamw"
    learning_rate: 0.0001
    weight_decay: 0.00001
    betas: [0.9, 0.999]

  # Scheduler
  scheduler:
    type: "cosine"
    warmup_epochs: 3
    min_lr: 0.000001

  # Training parameters
  epochs: 50
  batch_size: 4  # REDUZIDO para limite 6GB VRAM
  max_tests_per_build: 50  # Truncate to avoid memory issues
  gradient_accumulation_steps: 8  # Effective batch = 4*8 = 32

  # Early stopping based on validation APFD
  early_stopping:
    patience: 10
    metric: "val_apfd"
    mode: "max"

  # Gradient clipping
  gradient_clip: 1.0

# =============================================================================
# EVALUATION CONFIGURATION
# =============================================================================
evaluation:
  # Metrics to compute
  metrics:
    - "apfd"
    - "apfd_at_5"
    - "apfd_at_10"
    - "apfd_at_20"
    - "first_failure_position"
    - "recall_at_5"
    - "recall_at_10"

  # Baselines to compare against
  baselines:
    - "untreated"
    - "random"
    - "recently-failed"
    - "optimal-failure"
    - "optimal-failure-duration"
    - "matrix-naive"
    - "matrix-conditional-prob"

  # Statistical tests
  statistical:
    test: "wilcoxon"
    alpha: 0.05

# =============================================================================
# EMBEDDING CONFIGURATION
# =============================================================================
embeddings:
  model: "sentence-transformers/all-mpnet-base-v2"
  batch_size: 32  # REDUZIDO para limite 6GB VRAM
  max_length: 64  # Shorter for class names
  cache_dir: "cache/rtptorrent_embeddings"

# =============================================================================
# HARDWARE CONFIGURATION
# =============================================================================
hardware:
  device: "cuda"
  mixed_precision: true
  num_workers: 4
  pin_memory: true

# =============================================================================
# OUTPUT CONFIGURATION
# =============================================================================
output:
  results_dir: "results/experiment_rtptorrent_l2r"
  save_model: true
  save_predictions: true
  save_per_build_results: true

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: "INFO"
  log_every_n_steps: 100
  tensorboard: false  # Optional
